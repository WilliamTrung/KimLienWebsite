events {}

http {
    ##
    ## Restore real visitor IP from Cloudflare
    ## (required for correct logging & security)
    ##
    real_ip_header CF-Connecting-IP;

    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;

    ##
    ## Upstreams
    ##
    upstream customer {
        server customer:8080;
    }

    upstream admin {
        server administrator:8080;
    }

    ##
    ## Server
    ##
    server {
        listen 80;
        listen [::]:80;

        server_name _;

        #-----------------------------------------
        # Customer site
        #-----------------------------------------
        location / {
            proxy_pass http://customer;

            proxy_set_header Host $host;

            # Use real client IP from Cloudflare
            proxy_set_header X-Real-IP $http_cf_connecting_ip;
            proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;

            proxy_set_header X-Forwarded-Proto $scheme;
        }

        #-----------------------------------------
        # Admin site (case insensitive)
        #-----------------------------------------
        location ~* ^/Administrator(?:/|$) {
            # Strip the /Administrator prefix
            rewrite ^/Administrator/?(.*)$ /$1 break;

            proxy_pass http://admin;

            proxy_set_header Host $host;

            # Use real client IP from Cloudflare
            proxy_set_header X-Real-IP $http_cf_connecting_ip;
            proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
            proxy_set_header CF-Connecting-IP $http_cf_connecting_ip;

            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
